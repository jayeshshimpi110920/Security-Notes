
### **What is Cross-Site Request Forgery (CSRF)?**

**Cross-Site Request Forgery (CSRF)** is an attack where an attacker tricks a user into performing actions on a web application where they are authenticated, without their knowledge or consent. The attacker sends a request to the web application that the user is logged into, which then executes on behalf of the user without verifying if the action was intentionally initiated by them.

### **How CSRF Works:**

1. The victim logs into a web application and receives a session cookie.
2. While the session is active, the victim visits a malicious website or clicks on a link controlled by the attacker.
3. The attacker’s website sends a forged request to the legitimate application where the victim is authenticated.
4. The web application processes the request, believing it was initiated by the legitimate user (since the session cookie is valid), and performs the action.
   - Example: Transferring money, changing account details, or performing other critical actions.

### **Key Concepts of CSRF:**

- **Exploiting Trust in the User’s Browser**: Since the web application trusts the user’s authenticated session, the attacker leverages this trust to perform malicious actions.
- **No Access to Cookies**: The attacker doesn’t need to steal cookies or have direct access to the session token. The attack exploits the fact that the browser will automatically include session cookies in any request made to the web application.

### **CSRF Attack Example:**

1. The victim is logged into a banking website.
2. The victim receives an email with a link to a malicious website or clicks on an image on a forum.
3. The malicious website sends a hidden request:
   ```html
   <img src="https://bank.com/transfer?amount=1000&to_account=attacker_account">
   ```
4. The browser automatically includes the session cookie for the bank website in the request.
5. The banking website processes the transfer, believing it’s a legitimate request from the victim.

### **Consequences of CSRF:**

1. **Unauthorized Actions**:
   - CSRF can lead to unauthorized actions such as money transfers, changing email addresses, deleting user accounts, or modifying sensitive settings.

2. **Account Takeover**:
   - In some cases, CSRF attacks can lead to changes that allow the attacker to take control of the victim’s account, such as modifying a password or email.

3. **Data Theft or Loss**:
   - CSRF attacks can result in sensitive data being altered or deleted, leading to a loss of data integrity and potential privacy violations.

### **How to Prevent CSRF:**

1. **CSRF Tokens**:
   - Generate a unique CSRF token for each session or form request. The token should be included in every form submission or state-changing request (e.g., POST requests).
   - When the server receives a request, it checks if the CSRF token is valid and matches the session before processing the request.
   - Example:
     ```html
     <input type="hidden" name="csrf_token" value="abc123">
     ```

2. **SameSite Cookie Attribute**:
   - Use the `SameSite` cookie attribute to restrict how cookies are sent with cross-origin requests. Setting the `SameSite` attribute to `Strict` or `Lax` can help prevent browsers from sending cookies with cross-origin requests.
   - Example:
     ```text
     Set-Cookie: sessionId=abc123; SameSite=Strict
     ```

3. **Verify HTTP Referer Header**:
   - Some web applications check the `Referer` header to ensure that the request originated from the same site. However, this approach can be bypassed if the attacker finds a way to manipulate the `Referer` header.

4. **Use Double Submit Cookie**:
   - The application sends a CSRF token as a cookie and also includes it as a request parameter. The server then checks if the token in the cookie matches the one in the request.

5. **Use CAPTCHA**:
   - Adding CAPTCHA challenges to sensitive actions can ensure that the request is genuinely initiated by a human user and not an automated malicious action.

6. **Enforce POST Requests for Sensitive Actions**:
   - Limit sensitive actions to be performed only via POST requests instead of GET requests. GET requests should be idempotent and free from side effects.

### **How to Detect CSRF Vulnerabilities Manually (Penetration Testing):**

1. **Check for Missing CSRF Tokens**:
   - Look for state-changing requests (e.g., form submissions, POST requests) and check whether they include a CSRF token. If the token is missing or not validated, the application is vulnerable.

2. **Test GET Requests**:
   - Try executing sensitive actions via a crafted GET request by embedding the request in an `<img>`, `<script>`, or `<iframe>` tag. If the action succeeds without CSRF protection, the application is vulnerable.
   
   Example:
   ```html
   <img src="https://example.com/delete-account?user_id=123">
   ```

3. **Test POST Requests**:
   - Craft POST requests using tools like **Burp Suite** or **Postman** and observe whether the application requires a CSRF token and properly validates it.

4. **Check for SameSite Cookie Attribute**:
   - Inspect session cookies to see if they have the `SameSite` attribute set to `Strict` or `Lax`. If this attribute is missing or set to `None`, the application may be vulnerable to CSRF.

### **How to Detect CSRF with Tools:**

1. **Burp Suite**:
   - Burp Suite can automatically detect missing CSRF tokens on form submissions and flag potential vulnerabilities.
   - Use **Intruder** to test if sensitive actions can be triggered via CSRF by submitting crafted requests.

2. **OWASP ZAP**:
   - Use OWASP ZAP’s **Active Scanner** to automatically scan for CSRF vulnerabilities.
   - Manually test by sending malicious requests to see if the application processes them without validating the origin.

3. **Nessus**:
   - **Nessus** includes checks for CSRF vulnerabilities and will flag state-changing requests that do not include proper CSRF protection.

### **Example of CSRF Prevention Implementation:**

```html
<form action="/transfer-funds" method="POST">
    <input type="hidden" name="csrf_token" value="secure_token_123">
    <input type="text" name="amount" placeholder="Enter amount">
    <input type="text" name="account" placeholder="Enter account number">
    <input type="submit" value="Transfer">
</form>
```

In this example, the CSRF token `secure_token_123` is included in the form, and the server would validate this token when processing the request.

### **Conclusion:**

**CSRF** is a serious vulnerability that can lead to unauthorized actions being executed on behalf of an authenticated user. To prevent CSRF attacks, developers should implement CSRF tokens, use the `SameSite` cookie attribute, verify the `Referer` header, and enforce security measures like CAPTCHA for sensitive actions. Penetration testers can use manual methods and tools like Burp Suite and OWASP ZAP to identify and exploit CSRF vulnerabilities in web applications.
